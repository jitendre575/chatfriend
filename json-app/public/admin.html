<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - User App</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Login Overlay -->
    <div id="loginOverlay" class="login-overlay">
        <div class="container">
            <h1>Admin Login</h1>
            <div class="form-group">
                <label for="adminPass">Enter Admin Password</label>
                <input type="password" id="adminPass" placeholder="••••••••">
            </div>
            <button onclick="loginAdmin()" class="btn">Login</button>
            <div id="loginMessage" class="message error"></div>
            <div style="text-align: center; margin-top: 20px;">
                <a href="register.html" style="color: #94a3b8; font-size: 0.8rem; text-decoration: none;">Back to
                    Register</a>
            </div>
        </div>
    </div>

    <!-- Admin Content -->
    <div id="adminPanel" class="admin-container" style="display: none;">
        <h1 style="text-align: left;">Live Registered Users</h1>
        <div id="userGrid" class="user-grid">
            <!-- User cards will be injected here -->
        </div>
        <div style="margin-top: 30px; text-align: center;">
            <button onclick="logout()" class="btn"
                style="width: auto; padding: 10px 30px; background: #334155;">Logout</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYqfdHtFbTC4qt0Z45ts443SFQYg9v0r0",
            authDomain: "inpoint-app.firebaseapp.com",
            projectId: "inpoint-app",
            storageBucket: "inpoint-app.firebasestorage.app",
            messagingSenderId: "191388735788",
            appId: "1:191388735788:web:4e4a8c15263ba5fae07489"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global functions for buttons
        window.loginAdmin = async function () {
            const password = document.getElementById('adminPass').value;
            const loginMessage = document.getElementById('loginMessage');

            // Still using the server for secure password check
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    showAdminPanel();
                } else {
                    loginMessage.innerText = "Incorrect Password";
                    loginMessage.style.display = 'block';
                }
            } catch (error) {
                loginMessage.innerText = "Error connecting to server";
                loginMessage.style.display = 'block';
            }
        };

        window.showAdminPanel = function () {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            fetchUsersFromFirebase();
        };

        async function fetchUsersFromFirebase() {
            const userGrid = document.getElementById('userGrid');
            userGrid.innerHTML = '<p style="color: #94a3b8; grid-column: 1/-1; text-align: center;">Loading users...</p>';

            try {
                const q = query(collection(db, "users"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);

                userGrid.innerHTML = '';

                if (querySnapshot.empty) {
                    userGrid.innerHTML = '<p style="color: #94a3b8; grid-column: 1/-1; text-align: center;">No users registered yet.</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    card.innerHTML = `
                        <img src="${user.photoURL}" alt="${user.name}" class="user-img" onerror="this.src='https://via.placeholder.com/100'">
                        <div class="user-name">${user.name}</div>
                        <div class="user-email">${user.email}</div>
                    `;
                    userGrid.appendChild(card);
                });
            } catch (error) {
                console.error("Error:", error);
                userGrid.innerHTML = '<p style="color: red; grid-column: 1/-1; text-align: center;">Error loading users from Firebase.</p>';
            }
        }

        window.logout = function () {
            sessionStorage.removeItem('adminLoggedIn');
            location.reload();
        };

        // Auto-login check
        if (sessionStorage.getItem('adminLoggedIn') === 'true') {
            window.showAdminPanel();
        }
    </script>
</body>

</html>